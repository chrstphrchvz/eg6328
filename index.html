<!DOCTYPE html>
<html lang="en">
<head>
<title>HCS12 Editor</title>
<!--<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
</style>-->
</head>
<body>
<h1>HCS12 Editor</h1>
<button onclick="newAsmFile(event)">New asm file</button>
<!--<button onclick="editor.getContents()">Open asm file</button>-->
<!-- cf. https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications -->
<input type="file" id="input" value="Open asm file" onchange="openAsmFile(event)" />
<button onclick="saveAsmFile(event)">Save asm file</button>
<button onclick="runAssembler(event)">Run assembler</button>
<button onclick="editor.getContents()" disabled>Download to board</button>
<button onclick="download('myprogram.s19',SRecordFile)">Download S-record</button>
<br />
<!-- suggest using js directly instead of IFrame -->
<!--
<iframe id="asmeditor" style="height: 500px; width: 100%; border: none;" src="ace-builds/editor.html">If you're reading this your browser does not support IFrames</iframe>
-->
<div id="editor" style="height: 500px; width: 100%"></div>
<!-- cf. https://learn.sparkfun.com/tutorials/terminal-basics/codebender-serial-monitor-browser-based- -->
<!-- Will need to use js directly. Can't access cf from IFrame -->
<iframe id="serialmon" style="height: 510px; width: 100%; margin: 10px 0 10px; border:none;" allowTransparency="true" src="https://codebender.cc/embed/serialmonitor"></iframe>

<!--
<div id="cb_cf_serial_monitor" style="height: 500px; width: 100%; margin: 10px 0 10px; border:none;"></div>
-->

<!-- adapted from https://codebender.cc/embed/serialmonitor -->
<!-- not working yet
<div class="well">
	<h4>Serial Monitor: </h4>
	<div id="controls-container">
		<span>Port:</span>
		<select id="cb_cf_ports"></select>
		<span>Speed:</span>
		<select id="cb_cf_baud_rates"></select>
		<button id="cb_cf_serial_monitor_connect" class="btn">
			<i class="icon-link"></i>
			Connect
		</button>
	</div>
	<div id="cb_cf_serial_monitor"></div>
	<div id="cb_cf_operation_output"></div>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="//codebender.cc/embed/compilerflasher.js" type="text/javascript"></script>
-->
<h2>Assembler messages</h2>
<div id="asmMessages" style="height: 500px; width: 100%"></div>
<h2>List file</h2>
<div id="listFile" style="height: 500px; width: 100%"></div>
<!-- load from CDN --> 
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js" type="text/javascript" charset="utf-8"></script>

<script>

	/* For handling unsaved changes, a few mechanisms are used:
	 * 1. window.onbeforeunload is set to a function that
	 *    checks if there are "unsaved changes" using isClean();
	 * 2. functions for new/open Asm file check if document
	 *    has changed, and if so will prompt using confirm();
	 *    they then markClean() the editor.
	 * The isClean() and markClean() are documented as undocumented.
	 *
	 * References:
	 * http://stackoverflow.com/a/1119324 (K. Henry)
	 * http://stackoverflow.com/a/19717243 (anonymous "A User")
	 * https://github.com/ajaxorg/ace/issues/324#issuecomment-60917355 (H. Amirjanyan)
	 * https://github.com/ajaxorg/ace/issues/324#issuecomment-151274762 (GitHub user vanillajonathan)
	 */ 


    var editor = ace.edit("editor");
	var unsavedMessage = 'Proceed without saving changes?';
	// adapted/copied from http://stackoverflow.com/a/1119324 (K. Henry)
	window.onbeforeunload = function (e) 
	{
		// If we haven't been passed the event get the window.event
		e = e || window.event;
		
		// check for unsaved changes
		if (!editor.session.getUndoManager().isClean())
		{
			// For IE6-8 and Firefox prior to version 4
			if (e) 
			{
				e.returnValue = unsavedMessage;
			}

			// For Chrome, Safari, IE8+ and Opera 12+
			return unsavedMessage;
		}
		else
		{
			return null;
		}
	};	
	function checkUnsavedChanges(){
		var clean = editor.session.getUndoManager().isClean();
		var confirmed = false;		
		if(!clean)
		{
			confirmed = confirm(unsavedMessage);
		}
		return clean || confirmed;
	}
	
	var SRecordFile = "";

	var asmMessages = ace.edit("asmMessages");
	asmMessages.setReadOnly(true);
	var listFile = ace.edit("listFile");
	listFile.setReadOnly(true);

    //editor.setTheme("ace/theme/monokai");
    //editor.getSession().setMode("ace/mode/javascript");
    /*
	$(document).ready(function(){
		compilerflasher = new compilerflasher(function () {return []});
    });
	*/


	// cf. https://developer.mozilla.org/en-US/docs/Web/API/FileReader/onload
	function openAsmFile(event) {
		if (checkUnsavedChanges()) {
			var asmFile = event.target.files[0];
			var reader = new FileReader();
			reader.onload = function(event){
				// don't select text
				// cf. https://github.com/ajaxorg/ace/issues/1485
				editor.setValue(event.target.result, -1);	
		    	editor.session.getUndoManager().markClean();	
				// workaround input onchange event not firing when same file is selected
				// cf. http://stackoverflow.com/a/12102992
				document.getElementById('input').value = null;
			};
			reader.readAsText(asmFile);								
		}
	}
	function newAsmFile(event) {
		if (checkUnsavedChanges()) {
			editor.setValue("", -1);
		    editor.session.getUndoManager().markClean();
		}
	}
	function runAssembler(event) {
		// cf. http://stackoverflow.com/a/22858914
		var formData = new FormData();
		var blob = new Blob([editor.getValue()], {type: 'plain/text'});
		formData.append('fileupload', blob, "s12edit.asm");
		// cf. https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch
		fetch("cgi-bin/asmstrings.pl", {
			method: "POST",
			body: formData
		}).then(function(response) {
			var contentType = response.headers.get("content-type");
			if(contentType && contentType.indexOf("application/json") !== -1) {
				return response.json().then(function(json) {
					SRecordFile = json.SRecordFile;
					listFile.setValue(json.listFile, -1);
					asmMessages.setValue(json.asmMessages, -1);
				});
			} else {
				console.log("Oops, we haven't got JSON!");
			}
		});
	}
	// copied from http://stackoverflow.com/a/18197341 (Pokorn√Ω, Flaschen, et al.) 
	// (creates an <a href="..."></a> element, clicks it, then deletes it.)
	// NOTE: using FileSaver.js would be better in order to replicate "Save As" functionality in desktop program
	function download(filename, text) {
		var element = document.createElement('a');
		element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
		element.setAttribute('download', filename);
		element.style.display = 'none';
		document.body.appendChild(element);
		element.click();
		document.body.removeChild(element);
	}
	function saveAsmFile(event) {
		download('myprogram.asm',editor.getValue());
	    editor.session.getUndoManager().markClean();
	}
</script>
</body>
</html>
