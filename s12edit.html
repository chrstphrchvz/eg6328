<!DOCTYPE html>
<html lang="en">
<head>
<title>HCS12 Editor</title>
<!--<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
</style>-->
</head>
<body>
<h1>HCS12 Editor</h1>
<button onclick="newAsmFile(event)">New asm file</button>
<!--<button onclick="editor.getContents()">Open asm file</button>-->
<!-- cf. https://developer.mozilla.org/en-US/docs/Using_files_from_web_applications -->
<input type="file" id="input" value="Open asm file" onchange="openAsmFile(event)" />
<button onclick="editor.getContents()">Save asm file</button>
<button onclick="runAssembler(event)">Run assembler</button>
<button onclick="editor.getContents()" disabled>Download to board</button>
<button onclick="" disabled>Download S-record</button>
<br />
<!-- suggest using js directly instead of IFrame -->
<!--
<iframe id="asmeditor" style="height: 500px; width: 100%; border: none;" src="ace-builds/editor.html">If you're reading this your browser does not support IFrames</iframe>
-->
<div id="editor" style="height: 500px; width: 100%"></div>
<!-- cf. https://learn.sparkfun.com/tutorials/terminal-basics/codebender-serial-monitor-browser-based- -->
<!-- Will need to use js directly. Can't access cf from IFrame -->
<iframe id="serialmon" style="height: 510px; width: 100%; margin: 10px 0 10px; border:none;" allowTransparency="true" src="https://codebender.cc/embed/serialmonitor"></iframe>

<!--
<div id="cb_cf_serial_monitor" style="height: 500px; width: 100%; margin: 10px 0 10px; border:none;"></div>
-->

<!-- adapted from https://codebender.cc/embed/serialmonitor -->
<!-- not working yet
<div class="well">
	<h4>Serial Monitor: </h4>
	<div id="controls-container">
		<span>Port:</span>
		<select id="cb_cf_ports"></select>
		<span>Speed:</span>
		<select id="cb_cf_baud_rates"></select>
		<button id="cb_cf_serial_monitor_connect" class="btn">
			<i class="icon-link"></i>
			Connect
		</button>
	</div>
	<div id="cb_cf_serial_monitor"></div>
	<div id="cb_cf_operation_output"></div>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="//codebender.cc/embed/compilerflasher.js" type="text/javascript"></script>
-->
<h2>Assembler messages</h2>
<div id="asmMessages" style="height: 500px; width: 100%"></div>
<h2>List file</h2>
<div id="listFile" style="height: 500px; width: 100%"></div>
<!-- load from CDN --> 
<script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js" type="text/javascript" charset="utf-8"></script>

<script>
	// TODO: prompt for unsaved changes before navigating
	
	var SRecordFile = "";

    var editor = ace.edit("editor");
	var asmMessages = ace.edit("asmMessages");
	asmMessages.setReadOnly(true);
	var listFile = ace.edit("listFile");
	listFile.setReadOnly(true);

    //editor.setTheme("ace/theme/monokai");
    //editor.getSession().setMode("ace/mode/javascript");
    /*
	$(document).ready(function(){
		compilerflasher = new compilerflasher(function () {return []});
    });
	*/
	/* TODO: use this to prompt for unsaved changes with new/open file
	function promptUnsavedChanges(){
		if editor.document ...
	}
	*/
	// cf. https://developer.mozilla.org/en-US/docs/Web/API/FileReader/onload
	function openAsmFile(event) {
		// TODO: prompt for unsaved changes
		var asmFile = event.target.files[0]
		var reader = new FileReader();
		reader.onload = function(event){
			// don't select text
			// cf. https://github.com/ajaxorg/ace/issues/1485
			editor.setValue(event.target.result, -1);		
		};
		reader.readAsText(asmFile);
	}
	function newAsmFile(event) {
		// TODO: prompt for unsaved changes
		editor.setValue("", -1);
	}
	function runAssembler(event) {
		// cf. http://stackoverflow.com/a/22858914
		var formData = new FormData();
		var blob = new Blob([editor.getValue()], {type: 'plain/text'});
		formData.append('fileupload', blob, "s12edit.asm");
		var request = new XMLHttpRequest();
		request.type = "json";
		request.onreadystatechange = function(event){
			if(request.readyState === XMLHttpRequest.DONE && request.status === 200) {
		        console.log(request.responseText);
				SRecordFile = request.response.SRecordFile;
				listFile.setValue(request.response.listFile, -1);
				asmMessages.setValue(request.response.asmMessages, -1);
			}
		};
		request.open("POST", "cgi-bin/asmstrings.cgi");
		request.send(formData);
	}
	
</script>
</body>
</html>
